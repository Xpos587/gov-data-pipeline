# Gov Data Pipeline

Автоматизированная система для регулярного сбора и обработки данных из официальных таможенных реестров Беларуси, Казахстана и Киргизии.  
Основная цель — еженедельное получение данных, преобразование их в унифицированный Excel-формат, анализ изображений (OCR/GPT) и корректировка текста с помощью LLM (GPT).

---

## Описание проекта

1. **Беларусь**

   - **URL для скачивания:** [https://www.customs.gov.by/zashchita-prav-na-obekty-intellektualnoy-sobstvennosti](https://www.customs.gov.by/zashchita-prav-na-obekty-intellektualnoy-sobstvennosti)
   - Обработчик: `BelarusHandler`
   - Особенности: поиск `.xlsx` файла по шаблонной ссылке, загрузка, базовая очистка.

2. **Казахстан**

   - **URL для скачивания:** [https://kgd.gov.kz/ru/content/tamozhennyy-reestr-obektov-intellektualnoy-sobstvennosti-1](https://kgd.gov.kz/ru/content/tamozhennyy-reestr-obektov-intellektualnoy-sobstvennosti-1)
   - Обработчик: `KazakhstanHandler`
   - Особенности:
     - Предобработка изображений (конвертация в `data:image/png;base64,...`)
     - Передача столбца с ТМ и описанием в GPT для распознавания брендов и корректировки.

3. **Киргизия**
   - **URL для скачивания:** [https://www.customs.gov.kg/article/get?id=46&lang=ru](https://www.customs.gov.kg/article/get?id=46&lang=ru)
   - Обработчик: `KyrgyzstanHandler`
   - Особенности: скачивание PDF, затем через сервис ilovepdf загрузка и конвертация в DOCX, после чего извлечение таблиц.

---

## Коррекция текста и GPT

1. **LLM (GPT) для исправления текста**
   - Система использует модели GPT для устранения опечаток, разрывов строк и прочих искажений после конвертации.
2. **OCR через GPT**
   - В Казахстане, если встречаются изображения, они конвертируются в base64 и могут быть дополнительно интерпретированы GPT Vision (вместо классического Tesseract).
3. **Генерация сэмплов ТМ**
   - GPT может генерировать варианты написания ТМ на русском и английском языках.

---

## Ограничения

1. [ ] **Python 3.12** — код не тестировался на более ранних версиях.
2. [ ] **Изображения**:
   - [x] Сложность из-за нестандартных форматов (WFM, EFM)
   - [ ] Неструктурированное расположение в исходных Excel
3. [x] **PDF** — обработка для Киргизии пока ограничена конвертацией (через ilovepdf), без глубокой OCR.

---

## Установка

### Системные требования

- **Python**: 3.12 или выше.
- **Зависимости**: перечислены в `environment.yml` или `requirements.txt`.

### Установка зависимостей (через `requirements.txt`)

1. Создайте виртуальное окружение:

   ```bash
   python -m venv venv
   source venv/bin/activate     # Linux/Mac
   venv\Scripts\activate        # Windows
   ```

2. Установите пакеты:

   ```bash
   pip install -r requirements.txt
   ```

_(При желании можно использовать `environment.yml` вместе с Conda/Mamba.)_

---

## Настройка

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/Xpos587/gov-data-pipeline.git
   cd gov-data-pipeline
   ```

2. Создайте файл `.env` на базе `.env.dist`:

   ```bash
   cp .env.dist .env
   ```

3. Укажите нужные параметры в `.env`:
   - **SFTP**: параметры сервера, куда выгружаются итоговые Excel-файлы (`SFTP_HOST`, `SFTP_PORT`, `SFTP_USER` и т.д.).
   - **OpenAI API**: для GPT (`OPENAI_BASE_URL`, `OPENAI_API_KEY`).

---

## Использование

1. Убедитесь, что `.env` корректно заполнен (OpenAI и SFTP).
2. Запустите `main.py`:

   ```bash
   python main.py
   ```

3. Логи будут в консоли (на русском языке). При превышении лимитов (429) или ошибках аутентификации (401) скрипт повторит запросы автоматически.

---

## Архитектура проекта

- **handlers**
  Включает классы для каждой страны (`BelarusHandler`, `KazakhstanHandler`, `KyrgyzstanHandler`).
  Каждый хендлер умеет скачивать и преобразовывать данные.

- **utils**

  - **gpt.py**: функции для работы с GPT (распознавание брендов, корректировка строк, обработка изображений).
  - **settings.py**: конфигурации SFTP и OpenAI.
  - **sftp.py**: загрузка результатов на SFTP.
  - **loggers**: настройки логирования.

- **main.py**
  Точка входа. Инициализирует все хендлеры, обрабатывает результаты, при необходимости выгружает на SFTP.

---

## Лицензия

Проект распространяется под лицензией [MIT](LICENSE).
